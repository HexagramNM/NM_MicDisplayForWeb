<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="image/NM_MicDisplay_icon.ico">
  <title>NM_MicDisplay for Web</title>
  <!-- Require the peer dependencies of pose-detection. -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>

  <!-- You must explicitly require a TF.js backend if you're not using the TF.js union bundle. -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script type="text/javascript" src="globalVariables.js"></script>
  <script type="text/javascript" src="createWebGLObj.js"></script>
  <script type="text/javascript" src="virtualBack.js"></script>
  <script type="text/javascript" src="sharedWindow.js"></script>
  <script type="text/javascript" src="minMatrix.js"></script>
  <script type="text/javascript" src="NM_MicDisplay.js"></script>
  <script type="text/javascript" src="main.js"></script>

  <script id="vshader" type="x-shader/x-vertex">
  		attribute vec3 position;
  		attribute vec4 color;
  		attribute vec2 textureCoord;
  		uniform mat4 mvpMatrix;
  		varying vec4 vColor;
  		varying vec2 vTextureCoord;
  		void main(void) {
  			vColor = color;
  			vTextureCoord = textureCoord;
  			gl_Position = mvpMatrix*vec4(position, 1.0);
  		}
  </script>

  <script id="backMaskShader" type="x-shader/x-fragment">
      precision mediump float;
      uniform sampler2D texture;
      varying vec4 vColor;
      varying vec2 vTextureCoord;
      void main(void) {
        vec4 smpColor = texture2D(texture, vTextureCoord);
        float grayScale = smpColor.r * 0.299 + smpColor.g * 0.587 + smpColor.b * 0.114;
        float canvasWidth = 480.0;
        float invCanvasWidth = 1.0 / 480.0;
        float canvasHeight = 360.0;
        float invCanvasHeight = 1.0 / 360.0;
        float edgeSize = 40.0;
        float invEdgeSize = 1.0 / 40.0;
        float widthEdge = edgeSize * invCanvasWidth;
        float heightEdge = edgeSize * invCanvasHeight;
        float invWidthEdge = canvasWidth * invEdgeSize;
        float invHeightEdge = canvasHeight * invEdgeSize;
        float maxAlpha = 220.0 / 255.0;
        float edgeAlpha = 1.0;

        smpColor.r = (grayScale * 0.45 + 0.05);
        smpColor.g = (grayScale * 0.6 + 0.2);
        smpColor.b = (grayScale * 0.6 + 0.4);

        edgeAlpha = clamp(vTextureCoord.x, 0.0, widthEdge) * invWidthEdge;
        edgeAlpha = min(clamp(1.0 - vTextureCoord.x, 0.0, widthEdge) * invWidthEdge, edgeAlpha);
        edgeAlpha = min(clamp(vTextureCoord.y, 0.0, heightEdge) * invHeightEdge, edgeAlpha);
        edgeAlpha = min(clamp(1.0 - vTextureCoord.y, 0.0, heightEdge) * invHeightEdge, edgeAlpha);

        smpColor.a = smpColor.a * maxAlpha * edgeAlpha;
        gl_FragColor = vColor * smpColor;
      }
  </script>

  <script id="fshader" type="x-shader/x-fragment">
  		precision mediump float;
      uniform int enableTexture;
  		uniform sampler2D texture;
      uniform vec4 globalColor;
  		varying vec4 vColor;
  		varying vec2 vTextureCoord;
  		void main(void) {
        if (enableTexture != 0) {
  			     vec4 smpColor = texture2D(texture, vTextureCoord);
  			     gl_FragColor = vColor * smpColor * globalColor;
        }
        else {
             gl_FragColor = vColor * globalColor;
        }
  		}
  		</script>
  </head>
</head>

<body onload="VirtualBB_main()" style="margin: 0; padding: 0; overflow: hidden">
  <div id="easyInst" style="color: #FFFFFF">
    <h2>使用方法</h2>
    1. マイクやカメラについて使用許可の確認画面が出てきたら、許可してください。<br>
    2. 使用するマイク、カメラを選択し、スタートボタンを押してください。<br>
    3. 画面共有をする場合、共有する画面の右下にカメラ映像が入ります。<br>
    「ウィンドウをキャプチャ」を選択した場合は開始前に、共有するウィンドウを選択するオプションが開きます。<br>
    選択しない場合は画面いっぱいにカメラ映像が映ります。<br><br>
    ・カメラ映像について<br>
    カメラ映像を右クリックすると左右反転します。<br><br>
    ・画面共有時について<br>
    画面共有状態の場合、ドラッグでカメラ映像を動かすことができます。<br>
    Tキーを押すと、共有画面のトリミング設定を開きます。赤枠が出るので、マウスで辺をドラッグしてください。<br>
    Bキーを押すと、カメラ映像に半透明黒色背景を追加します。再度Bキーを押すことで背景を非表示にします。<br><br>
    使用カメラ：<select id="cameraSelect" style="width: 200px"><option value="default">デフォルト</option></select><br>
    使用マイク：<select id="micSelect" style="width: 200px"><option value="default">デフォルト</option></select><br>
    画面共有：<select id="sharedWindowSelect" style="width: 200px">
      <option value="none">しない</option>
      <option value="windowCapture">ウィンドウをキャプチャ</option>
    </select><br>
    <button id="startButton" type="button" disabled>スタート</button>
  </div>
  <div id="errorPermission" style="color: #FFFFFF; display: none">
    ブラウザ側でマイクやカメラの使用が拒否されています。ブラウザの設定を修正し、ページを更新してください。
  </div>
  <div id="main">
    <video id="underBackground" style="position: absolute; top: 0px; left: 0px; z-index: 0"></video>
    <div id="trimmingBox" style="position: absolute; top: 0px; left: 0px; z-index: 1;
    border-style: solid; color: red; border-color: red; border-width: 3px;
    user-select: none; display: none">
      <h2>トリミングモード</h2>
      辺をドラッグしてください。（Tキーで確定、Rキーで枠のリセット）
    </div>
    <video id="video" style="display: none"></video>
    <canvas id="intermediate" style="display: none"></canvas>
    <canvas id="NM_MicDisplayOutput" style="position: relative; z-index: 2"></canvas>
  </div>
</body>
</html>
