<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="image/NM_MicDisplay_icon.ico">
  <title>NM_MicDisplay for Web</title>
  <!-- Require the peer dependencies of pose-detection. -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>

  <!-- You must explicitly require a TF.js backend if you're not using the TF.js union bundle. -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script type="text/javascript" src="globalVariables.js"></script>
  <script type="module" src="modules/createWebGLObj.js"></script>
  <script type="module" src="modules/virtualBack.js"></script>
  <script type="module" src="modules/sharedWindow.js"></script>
  <script type="module" src="modules/minMatrix.js"></script>
  <script type="module" src="modules/NM_MicDisplay.js"></script>
  <script type="module" src="main.js"></script>

  <script id="vshader" type="x-shader/x-vertex">
  		attribute vec3 position;
  		attribute vec4 color;
  		attribute vec2 textureCoord;
  		uniform mat4 mvpMatrix;
  		varying vec4 vColor;
  		varying vec2 vTextureCoord;
  		void main(void) {
  			vColor = color;
  			vTextureCoord = textureCoord;
  			gl_Position = mvpMatrix*vec4(position, 1.0);
  		}
  </script>

  <script id="backMaskShader" type="x-shader/x-fragment">
      #define PI 3.141592
      precision mediump float;
      uniform sampler2D texture;
      uniform float time;
      varying vec4 vColor;
      varying vec2 vTextureCoord;
      void main(void) {
        vec4 smpColor = texture2D(texture, vTextureCoord);
        float grayScale = smpColor.r * 0.299 + smpColor.g * 0.587 + smpColor.b * 0.114;
        float canvasWidth = 480.0;
        float invCanvasWidth = 1.0 / 480.0;
        float canvasHeight = 360.0;
        float invCanvasHeight = 1.0 / 360.0;
        float edgeSize = 40.0;
        float invEdgeSize = 1.0 / 40.0;
        float widthEdge = edgeSize * invCanvasWidth;
        float heightEdge = edgeSize * invCanvasHeight;
        float invWidthEdge = canvasWidth * invEdgeSize;
        float invHeightEdge = canvasHeight * invEdgeSize;
        float maxAlpha = 250.0 / 255.0;
        float edgeAlpha = 1.0;

        smpColor.r = (grayScale * 0.725 + 0.025);
        smpColor.g = (grayScale * 0.75 + 0.1);
        smpColor.b = (grayScale * 0.8 + 0.2);

        vec3 outlineColor;
        float outlineAlpha = pow(sin(smpColor.a * PI), 6.0);
        outlineColor.r = outlineAlpha * 0.8;
        outlineColor.g = outlineAlpha * 1.0;
        outlineColor.b = 1.0;

        smpColor.r = (1.0 - outlineAlpha) * smpColor.r + outlineAlpha * outlineColor.r;
        smpColor.g = (1.0 - outlineAlpha) * smpColor.g + outlineAlpha * outlineColor.g;
        smpColor.b = (1.0 - outlineAlpha) * smpColor.b + outlineAlpha * outlineColor.b;
        smpColor.a = min(1.0, smpColor.a + outlineAlpha * 0.9);

        edgeAlpha = clamp(vTextureCoord.x, 0.0, widthEdge) * invWidthEdge;
        edgeAlpha = min(clamp(1.0 - vTextureCoord.x, 0.0, widthEdge) * invWidthEdge, edgeAlpha);
        edgeAlpha = min(clamp(vTextureCoord.y, 0.0, heightEdge) * invHeightEdge, edgeAlpha);
        edgeAlpha = min(clamp(1.0 - vTextureCoord.y, 0.0, heightEdge) * invHeightEdge, edgeAlpha);

        float sinValue = sin((vTextureCoord.y + time * 0.01) * 50.0 * PI);
        float stripeAlpha = max(sinValue * sinValue, 0.9);

        smpColor.a = smpColor.a * maxAlpha  * edgeAlpha * stripeAlpha;
        gl_FragColor = vColor * smpColor;
      }
  </script>

  <script id="virtualShareWindowShader" type="x-shader/x-fragment">
      #define PI 3.141592
      precision mediump float;
      uniform sampler2D texture;
      uniform float time;
      varying vec4 vColor;
      varying vec2 vTextureCoord;
      void main(void) {
        vec4 smpColor = texture2D(texture, vTextureCoord);
        float maxAlpha = 200.0 / 255.0;
        float edgeAlpha = 1.0;
        float edgeRate = 0.02;
        float invEdgeRate = 1.0 / 0.02;
        float grayScale = smpColor.r * 0.299 + smpColor.g * 0.587 + smpColor.b * 0.114;

        smpColor.r = (grayScale * 0.5 + 0.2);
        smpColor.g = (grayScale * 0.6 + 0.2);
        smpColor.b = (grayScale * 0.6 + 0.4);

        edgeAlpha = clamp(vTextureCoord.x, 0.0, edgeRate) * invEdgeRate;
        edgeAlpha = min(clamp(1.0 - vTextureCoord.x, 0.0, edgeRate) * invEdgeRate, edgeAlpha);
        edgeAlpha = min(clamp(vTextureCoord.y, 0.0, edgeRate) * invEdgeRate, edgeAlpha);
        edgeAlpha = min(clamp(1.0 - vTextureCoord.y, 0.0, edgeRate) * invEdgeRate, edgeAlpha);

        smpColor.a = maxAlpha * edgeAlpha;

        gl_FragColor = vColor * smpColor;
      }
  </script>

  <script id="fshader" type="x-shader/x-fragment">
  		precision mediump float;
      uniform int enableTexture;
  		uniform sampler2D texture;
      uniform vec4 globalColor;
  		varying vec4 vColor;
  		varying vec2 vTextureCoord;
  		void main(void) {
        if (enableTexture != 0) {
  			     vec4 smpColor = texture2D(texture, vTextureCoord);
  			     gl_FragColor = vColor * smpColor * globalColor;
        }
        else {
             gl_FragColor = vColor * globalColor;
        }
  		}
  		</script>
  </head>
</head>

<body style="margin: 0; padding: 0; overflow: hidden">
  <div id="easyInst" style="color: #FFFFFF">
    <h2>使用方法</h2>
    1. マイクやカメラについて使用許可の確認画面が出てきたら、許可してください。<br>
    2. 使用するマイク、カメラを選択し、スタートボタンを押してください。<br>
    3. 画面共有をする場合、共有する画面の右下にカメラ映像が入ります。<br>
    「ウィンドウをキャプチャ」を選択した場合は開始前に、共有するウィンドウを選択するオプションが開きます。<br>
    選択しない場合は画面いっぱいにカメラ映像が映ります。<br><br>
    ・カメラ映像について<br>
    カメラ映像を右クリックすると左右反転します。<br><br>
    ・画面共有時について<br>
    画面共有状態の場合、ドラッグでカメラ映像を動かすことができます。<br>
    Tキーを押すと、共有画面のトリミング設定を開きます。赤枠が出るので、マウスで辺をドラッグしてください。<br>
    Bキーを押すと、カメラ映像に半透明黒色背景を追加します。再度Bキーを押すことで背景を非表示にします。<br>
    Sキーを押すと、共有画面を非表示にし、カメラ映像を画面いっぱいに映します。再度Sキーを押すと共有画面を再表示します。<br>
    画面を共有している場合、共有画面がカメラ映像の前にも表示されます。<br><br>
    使用カメラ：<select id="cameraSelect" style="width: 200px"><option value="default">デフォルト</option></select><br>
    使用マイク：<select id="micSelect" style="width: 200px"><option value="default">デフォルト</option></select><br>
    画面共有：<select id="sharedWindowSelect" style="width: 200px">
      <option value="none">しない</option>
      <option value="windowCapture">ウィンドウをキャプチャ</option>
    </select><br>
    BlazePoseモデル：<select id="blazePoseModelType" style="width: 200px">
      <option value="full">full (標準)</option>
      <option value="lite">lite (軽量)</option>
      <option value="heavy">heavy (高品質)</option>
    </select><br>
    <button id="startButton" type="button" disabled>スタート</button>
  </div>
  <div id="errorPermission" style="color: #FFFFFF; display: none">
    ブラウザ側でマイクやカメラの使用が拒否されています。ブラウザの設定を修正し、ページを更新してください。
  </div>
  <div id="main">
    <video id="virtualShareWindowVideo" style="display: none"></video>
    <canvas id="virtualShareWindowTexture" style="display: none"></canvas>
    <video id="underBackground" style="position: absolute; top: 0px; left: 0px; z-index: 0"></video>
    <div id="trimmingBox" style="position: absolute; top: 0px; left: 0px; z-index: 1;
    border-style: solid; color: red; border-color: red; border-width: 3px;
    user-select: none; display: none">
      <h2>トリミングモード</h2>
      辺をドラッグしてください。（Tキーで確定、Rキーで枠のリセット）
    </div>
    <video id="virtualBackVideo" style="display: none"></video>
    <canvas id="virtualBackIntermediate" style="display: none"></canvas>
    <canvas id="virtualBackBlazePose" style="display: none"></canvas>
    <canvas id="virtualBackPreviousFrame" style="display: none"></canvas>
    <canvas id="virtualBackMask" style="display: none"></canvas>
    <canvas id="virtualBackTexture" style="display: none"></canvas>
    <canvas id="NM_MicDisplayOutput" style="position: relative; z-index: 2"></canvas>
  </div>
</body>
</html>
